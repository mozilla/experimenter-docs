<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-deep-dives/jetstream/operations" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.4.3">
<title data-rh="true">Jetstream Architecture and Operations | Experimenter Docs</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://experimenter.info/deep-dives/jetstream/operations"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Jetstream Architecture and Operations | Experimenter Docs"><meta data-rh="true" name="description" content="Jetstream is part of the Cirrus ecosystem and depends on some external services."><meta data-rh="true" property="og:description" content="Jetstream is part of the Cirrus ecosystem and depends on some external services."><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://experimenter.info/deep-dives/jetstream/operations"><link data-rh="true" rel="alternate" href="https://experimenter.info/deep-dives/jetstream/operations" hreflang="en"><link data-rh="true" rel="alternate" href="https://experimenter.info/deep-dives/jetstream/operations" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.5dfa870c.css">
<link rel="preload" href="/assets/js/runtime~main.47aa3ee0.js" as="script">
<link rel="preload" href="/assets/js/main.150d7869.js" as="script">
</head>
<body class="navigation-with-keyboard" data-theme="light">
<script>!function(){function e(e){document.documentElement.setAttribute("data-theme",e)}var t=function(){var e=null;try{e=new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(e){}return e}()||function(){var e=null;try{e=localStorage.getItem("theme")}catch(e){}return e}();null!==t?e(t):window.matchMedia("(prefers-color-scheme: dark)").matches?e("dark"):(window.matchMedia("(prefers-color-scheme: light)").matches,e("light"))}()</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="Experimenter Logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/logo-dark.svg" alt="Experimenter Logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">Mozilla Experimentation and Feature Delivery</b></a></div><div class="navbar__items navbar__items--right"><a href="https://experimenter.services.mozilla.com/nimbus/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Nimbus<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><a href="https://mozilla-hub.atlassian.net/wiki/spaces/PXI/pages/426934273/Nimbus" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Confluence<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><a href="https://github.com/mozilla/experimenter-docs" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-github-link" aria-label="GitHub repository"></a><div class="searchBox_ZlJk"><div class="dsla-search-wrapper"><div class="dsla-search-field" data-tags="default,docs-default-current"></div></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebarViewport_Xe31"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/">Welcome</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/whats-news/2024-Q1">What&#x27;s Newsletter</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/access">Getting Started</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/workflow/overview">Experimentation Workflow</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" href="/deep-dives/jetstream/overview">Deep Dives</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" tabindex="0" href="/deep-dives/jetstream/overview">Jetstream</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/deep-dives/jetstream/overview">Overview</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/deep-dives/jetstream/metrics">Metrics</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/deep-dives/jetstream/statistics">Statistics</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/deep-dives/jetstream/outcomes">Outcomes</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/deep-dives/jetstream/configuration">Configuring Jetstream</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/deep-dives/jetstream/data-products">Data products</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/deep-dives/jetstream/operations">Architecture and Operations</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/deep-dives/jetstream/troubleshooting">Troubleshooting</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/deep-dives/jetstream/testing">Testing Jetstream Configs</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/deep-dives/jetstream/adding-a-platform">Adding a Platform</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a href="https://github.com/mozilla/jetstream" target="_blank" rel="noopener noreferrer" class="menu__link menuExternalLink_NmtK" tabindex="0">Jetstream GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/bucketing">Data topics</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/desktop-enroll-locally">Desktop topics</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/mobile-behavioral-targeting">Mobile topics</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/deep-dives/experimenter/branches-page">Experimenter topics</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/client-sdk-states-and-lifecycle">Specifications</a></div></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/cookbook/fml/fml-cookbook">Experimentation Cookbook</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/faq/general-faq">FAQ</a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/glossary">Glossary</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/integration-tests">Additional Links</a></div></li></ul></nav><button type="button" title="Collapse sidebar" aria-label="Collapse sidebar" class="button button--secondary button--outline collapseSidebarButton_PEFL"><svg width="20" height="20" aria-hidden="true" class="collapseSidebarButtonIcon_kv0_"><g fill="#7a7a7a"><path d="M9.992 10.023c0 .2-.062.399-.172.547l-4.996 7.492a.982.982 0 01-.828.454H1c-.55 0-1-.453-1-1 0-.2.059-.403.168-.551l4.629-6.942L.168 3.078A.939.939 0 010 2.528c0-.548.45-.997 1-.997h2.996c.352 0 .649.18.828.45L9.82 9.472c.11.148.172.347.172.55zm0 0"></path><path d="M19.98 10.023c0 .2-.058.399-.168.547l-4.996 7.492a.987.987 0 01-.828.454h-3c-.547 0-.996-.453-.996-1 0-.2.059-.403.168-.551l4.625-6.942-4.625-6.945a.939.939 0 01-.168-.55 1 1 0 01.996-.997h3c.348 0 .649.18.828.45l4.996 7.492c.11.148.168.347.168.55zm0 0"></path></g></svg></button></div></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Deep Dives</span><meta itemprop="position" content="1"></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Jetstream</span><meta itemprop="position" content="2"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Architecture and Operations</span><meta itemprop="position" content="3"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Jetstream Architecture and Operations</h1></header><p><a href="/deep-dives/jetstream/overview">Jetstream</a> is part of the Cirrus ecosystem and depends on some external services.</p><p><img loading="lazy" alt="Cirrus overview" src="/assets/images/cirrus-8bdea7b35470b1c920d0238d70ada0d2.png" width="2138" height="868" class="img_ev3q">
<em>High-level overview of Cirrus</em></p><p>Jetstream is <a href="https://github.com/mozilla/telemetry-airflow/blob/e5de501d8063cc366e9bb546135f3866136cb47d/dags/jetstream.py#L22" target="_blank" rel="noopener noreferrer">scheduled to run in Airflow</a> daily. The daily runs will analyze all experiments that are currently active or just ended the day before and write metrics, statistics and errors for each experiment to BigQuery. Active V1 experiments and V6 experiments (Nimbus experiments) are retrieved from the <a href="https://experimenter.services.mozilla.com/api/v1/experiments/" target="_blank" rel="noopener noreferrer">Experimenter API</a>.</p><p>Jetstream also fetches custom experiment and outcome configs from the <code>jetstream/</code> directory in <a href="https://github.com/mozilla/metric-hub/tree/main/jetstream" target="_blank" rel="noopener noreferrer">metric-hub</a> for analysis. When a new custom config gets merged into metric-hub, the CI will trigger Jetstream to re-run all analyses for the experiment affected by the config. CircleCI will report on the status of the analysis run and link to the Cloud Logging logs.</p><p>After writing analyses results to BigQuery, statistics data is exported to the <code>mozanalysis</code> bucket in GCS as JSON. The JSON data is accessed by the analysis dashboard to display results.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="architecture-for-scaling-jetstream">Architecture for Scaling Jetstream<a href="#architecture-for-scaling-jetstream" class="hash-link" aria-label="Direct link to Architecture for Scaling Jetstream" title="Direct link to Architecture for Scaling Jetstream">​</a></h2><p>To ensure analysis results are available in a timely manner, Jetstream implements two approaches for reducing the time required to run experiment analyses:</p><ul><li>Parallelization of experiment analyses using <a href="https://argoproj.github.io/" target="_blank" rel="noopener noreferrer">Argo</a></li><li>Parallelization of lower-level calculations (statistics, segments, ...) using <a href="https://dask.org/" target="_blank" rel="noopener noreferrer">Dask</a></li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="parallelizing-experiment-analyses">Parallelizing experiment analyses<a href="#parallelizing-experiment-analyses" class="hash-link" aria-label="Direct link to Parallelizing experiment analyses" title="Direct link to Parallelizing experiment analyses">​</a></h3><p><a href="https://argoproj.github.io/" target="_blank" rel="noopener noreferrer">Argo</a> is a light-weight workflow engine for orchestrating parallel jobs on Kubernetes and is capable of creating tasks dynamically that will be executed in parallel. Using Argo, the analyses for different experiments and analysis dates are split into separate jobs that run in parallel on the <code>jetstream</code> Kubernetes cluster in the <code>moz-fx-data-experiment-analysis</code> GCP project.</p><p>Argo expects each step in the workflow to be a container. The existing Jetstream container, which has the Jetstream CLI installed, can be used for each of these steps.
The full workflow definition is defined in <a href="https://github.com/mozilla/jetstream/blob/main/jetstream/workflows/run.yaml" target="_blank" rel="noopener noreferrer">the <code>workflows/run.yaml</code> file</a>.</p><p>Depending on how Jetstream is invoked (<code>rerun</code>, <code>run-argo</code>, or <code>rerun_config_changed</code>), Jetstream will determine the dates and experiments that are to be analyzed and injects them as parameters into <code>run.yaml</code> before launching the workflow. Argo will create separate jobs for each experiment and each analysis date. Once the analysis is complete, data gets exported as JSON to GCS.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="parallelizing-lower-level-calculations">Parallelizing lower-level calculations<a href="#parallelizing-lower-level-calculations" class="hash-link" aria-label="Direct link to Parallelizing lower-level calculations" title="Direct link to Parallelizing lower-level calculations">​</a></h3><p>In addition to running experiment analyses in parallel, <a href="https://dask.org/" target="_blank" rel="noopener noreferrer">Dask</a> is used to parallelize lower-level calculations. The following steps could be executed in parallel:</p><ul><li>Analyses for each analysis period (daily, 28day, weekly, overall)</li><li>Analyses for different segments</li><li>Calculating statistics defined for an experiment analysis</li></ul><p>The <a href="https://docs.dask.org/en/latest/delayed.html" target="_blank" rel="noopener noreferrer"><code>dask.delayed interface</code></a> is used to turn the functions executing these steps into tasks that are added to a task graph which executes these steps in parallel. Dask is configured to use as many cores as are available on the machine by default, with 1 worker for each core. <a href="https://docs.dask.org/en/latest/scheduling.html#local-threads" target="_blank" rel="noopener noreferrer">Multi-threading being avoided, instead processes are used</a> since the code is dominated by Python code, otherwise there wouldn&#x27;t be any speedup due Python&#x27;s Global Interpreter Lock. To manually restrict the number of processes, the <code>JETSTREAM_PROCESSES</code> environment variable can be used.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="installation">Installation<a href="#installation" class="hash-link" aria-label="Direct link to Installation" title="Direct link to Installation">​</a></h2><p>Jetstream is executed on the <code>jetstream</code> Kubernetes cluster in the <code>moz-fx-data-experiments</code> project which is set up following <a href="https://github.com/argoproj/argo/blob/master/docs/quick-start.md" target="_blank" rel="noopener noreferrer">Argo&#x27;s installation guide</a>:</p><ul><li>When creating or re-creating the cluster, BigQuery and Compute Engine read/write permissions need to be enabled</li><li>Installing Argo:<ul><li>Create an <code>argo</code> namespace: <code>kubectl create ns argo</code></li><li>Install commonly used components: <code>kubectl apply -n argo -f https://github.com/argoproj/argo-workflows/releases/download/v3.4.5/install.yaml</code></li><li>Create new <code>clusterrole</code>: <code>kubectl create rolebinding default-admin --clusterrole=admin --serviceaccount=argo:default --namespace=argo</code></li></ul></li><li>The <a href="https://github.com/mozilla/telemetry-airflow/blob/master/dags/jetstream.py" target="_blank" rel="noopener noreferrer"><code>jetstream</code> DAG in Airflow</a> triggers the <code>run-argo</code> job daily and either requires Compute Engine API access or the parameters <code>cluster_ip</code> and <code>cluster_cert</code> need to be provided<ul><li>Currently the Airflow cluster does not have Compute Engine API access, so the cluster IP and certificate are stored as secrets and used for running Jetstream</li></ul></li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="argo-workflow-ui">Argo Workflow UI<a href="#argo-workflow-ui" class="hash-link" aria-label="Direct link to Argo Workflow UI" title="Direct link to Argo Workflow UI">​</a></h2><p>Argo provides a Web UI to access running workflows. Users need to authenticate using a Bearer token:</p><ul><li>set <code>export CLOUDSDK_CORE_PROJECT=moz-fx-data-experiments</code></li><li>Get Bearer token and copy: <code>gcloud container clusters get-credentials jetstream --region=us-central1-a &amp;&amp; kubectl -n argo exec $(kubectl get pod -n argo -l &#x27;app=argo-server&#x27; -o jsonpath=&#x27;{.items[0].metadata.name}&#x27;) -- argo auth token</code> </li><li>Connect to the Workflow UI using port forwarding: <code>kubectl -n argo port-forward svc/argo-server 2746:2746</code></li><li>Open <a href="https://localhost:2746" target="_blank" rel="noopener noreferrer">https://localhost:2746</a></li><li>Use the generated Bearer token (including the word <code>Bearer</code>) for authentication</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="deleting-old-workflows">Deleting Old Workflows<a href="#deleting-old-workflows" class="hash-link" aria-label="Direct link to Deleting Old Workflows" title="Direct link to Deleting Old Workflows">​</a></h3><ul><li>The Workflow UI might get less responsive the more workflows have been run in the past</li><li>To delete workflows that are older than 4 days run:</li></ul><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">kubectl get wf -o go-template -n argo --template &#x27;{{range .items}}{{.metadata.name}} {{.metadata.creationTimestamp}}{{&quot;\n&quot;}}{{end}}&#x27; | awk &#x27;$2 &lt;= &quot;&#x27;$(gdate -d &#x27;30 days ago&#x27; -Ins --utc | sed &#x27;s/+0000/Z/&#x27;)&#x27;&quot; { print $1 }&#x27; | gxargs --no-run-if-empty kubectl delete wf -n argo</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="cluster-updates">Cluster Updates<a href="#cluster-updates" class="hash-link" aria-label="Direct link to Cluster Updates" title="Direct link to Cluster Updates">​</a></h2><p>Argo updates should be tested on a separate cluster before applying them to production. Jetstream has some custom logic to connect to clusters and issue workflows that might be incompatible with future versions of Argo.</p><ul><li>Setup a separate cluster, install most recent Argo version<ul><li>Optionally, push a custom docker image that should be tested<ul><li><code>docker build -t jetstream-test .</code></li><li><code>docker tag jetstream-test gcr.io/moz-fx-data-experiments/jetstream-test:latest</code></li><li><code>gcloud auth configure-docker</code></li><li><code>docker push gcr.io/moz-fx-data-experiments/jetstream-test:latest</code></li><li>Update <a href="https://github.com/mozilla/jetstream/blob/main/jetstream/workflows/run.yaml" target="_blank" rel="noopener noreferrer">the workflow configuration file</a> to point to the docker image to be tested</li></ul></li></ul></li><li>To update Argo run:<ul><li>Connect to cluster: <code>gcloud container clusters get-credentials jetstream --region=us-central1-a</code></li><li>To install new release <code>kubectl apply -n argo -f https://github.com/argoproj/argo-workflows/releases/download/v3.4.5/install.yaml</code><ul><li>Change version number to most recent release</li></ul></li></ul></li><li>The GKE cluster itself is updated automatically by GCP</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="tooling-and-metric-versioning">Tooling and Metric Versioning<a href="#tooling-and-metric-versioning" class="hash-link" aria-label="Direct link to Tooling and Metric Versioning" title="Direct link to Tooling and Metric Versioning">​</a></h2><p>Jetstream uses the same tooling and metric versions for an experiment across its entire analysis duration. This prevents inconsistent results, for example, when changes are made to how <a href="https://github.com/mozilla/mozanalysis" target="_blank" rel="noopener noreferrer">mozanalysis</a> computes results or new default metrics are added in metric-hub mid-experiment.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="keeping-track-of-tooling-versions">Keeping track of tooling versions<a href="#keeping-track-of-tooling-versions" class="hash-link" aria-label="Direct link to Keeping track of tooling versions" title="Direct link to Keeping track of tooling versions">​</a></h3><p>When a new version of jetstream is released, for example after some library updates, a new Docker container gets pushed to the <a href="https://console.cloud.google.com/artifacts?project=moz-fx-data-experiments" target="_blank" rel="noopener noreferrer">Artifact Registry</a>. The container installs a specific version of each library and can be uniquely identified by a SHA256 hash. A timestamp indicating when the container was uploaded is also available.</p><p>Every time Jetstream runs and writes computed results to BigQuery, it tags the result tables with a last updated timestamp. However, the enrollments table won&#x27;t update on new Jetstream runs, giving us an anchor from which to identify a consistent Jetstream image hash. </p><p>The last updated timestamp of the enrollments table is used to determine which Docker container was the most recently published one at that time. This container is then be used for all subsequent analyses.</p><p>The Artifact Registry API is used to access image information and to determine the container to use for the analysis based on the last updated timestamp of the experiments enrollment table.</p><p>Container hashes are passed to the Argo workflow config, which references docker containers used for execution.</p><p>Jetstream can be run using a specific image version using the <code>--image_version</code> parameter. The image can also be changed using the <code>--image</code> parameter.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="keeping-track-of-metric-hub-versions">Keeping track of metric-hub versions<a href="#keeping-track-of-metric-hub-versions" class="hash-link" aria-label="Direct link to Keeping track of metric-hub versions" title="Direct link to Keeping track of metric-hub versions">​</a></h3><p>Outcome and default configs can potentially change mid-experiment, leaving some experiments in an inconsistent state. Since these configs get pulled in dynamically and aren&#x27;t installed as part of the Docker image the prior approach doesn&#x27;t work here.</p><p>Instead, <code>ConfigCollection.as_of(&lt;date&gt;)</code> is used to checkout an earlier version of the repo as of the provided date.
This date will again be based on the last updated timestamp of the enrollments table. Calling <code>as_of()</code> will load the configs, defaults and outcomes that will subsequently be used for analysis. <code>as_of()</code> iterates through the commit history until it finds the first commit from before the last updated timestamp. If this commit is in a broken state (i.e., configs cannot be successfully loaded), <code>as_of</code> works forward from this point to find the closest working commit.</p><p>When making changes to experiment-specific configs, jetstream will automatically rerun the affected experiments which will result in the enrollments table getting updated and the most recent configs in metric-hub being used.</p><p>More information on how to use the most recent tooling and metric versions can be found <a href="/deep-dives/jetstream/overview#how-to-use-the-latest-tooling-and-metric-definitions">here</a>.</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/mozilla/experimenter-docs/edit/main/docs/deep-dives/jetstream/operations.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_vwxv"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/deep-dives/jetstream/data-products"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Data products</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/deep-dives/jetstream/troubleshooting"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Troubleshooting</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#architecture-for-scaling-jetstream" class="table-of-contents__link toc-highlight">Architecture for Scaling Jetstream</a><ul><li><a href="#parallelizing-experiment-analyses" class="table-of-contents__link toc-highlight">Parallelizing experiment analyses</a></li><li><a href="#parallelizing-lower-level-calculations" class="table-of-contents__link toc-highlight">Parallelizing lower-level calculations</a></li></ul></li><li><a href="#installation" class="table-of-contents__link toc-highlight">Installation</a></li><li><a href="#argo-workflow-ui" class="table-of-contents__link toc-highlight">Argo Workflow UI</a><ul><li><a href="#deleting-old-workflows" class="table-of-contents__link toc-highlight">Deleting Old Workflows</a></li></ul></li><li><a href="#cluster-updates" class="table-of-contents__link toc-highlight">Cluster Updates</a></li><li><a href="#tooling-and-metric-versioning" class="table-of-contents__link toc-highlight">Tooling and Metric Versioning</a><ul><li><a href="#keeping-track-of-tooling-versions" class="table-of-contents__link toc-highlight">Keeping track of tooling versions</a></li><li><a href="#keeping-track-of-metric-hub-versions" class="table-of-contents__link toc-highlight">Keeping track of metric-hub versions</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2025 Mozilla Corporation</div></div></div></footer></div>
<script src="/assets/js/runtime~main.47aa3ee0.js"></script>
<script src="/assets/js/main.150d7869.js"></script>
</body>
</html>