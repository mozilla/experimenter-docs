"use strict";(globalThis.webpackChunkexperimenter_docs=globalThis.webpackChunkexperimenter_docs||[]).push([[4824],{5680(e,n,t){t.d(n,{xA:()=>d,yg:()=>m});var i=t(6540);function r(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function a(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);n&&(i=i.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,i)}return t}function o(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?a(Object(t),!0).forEach((function(n){r(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):a(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function l(e,n){if(null==e)return{};var t,i,r=function(e,n){if(null==e)return{};var t,i,r={},a=Object.keys(e);for(i=0;i<a.length;i++)t=a[i],n.indexOf(t)>=0||(r[t]=e[t]);return r}(e,n);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);for(i=0;i<a.length;i++)t=a[i],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(r[t]=e[t])}return r}var s=i.createContext({}),p=function(e){var n=i.useContext(s),t=n;return e&&(t="function"==typeof e?e(n):o(o({},n),e)),t},d=function(e){var n=p(e.components);return i.createElement(s.Provider,{value:n},e.children)},u={inlineCode:"code",wrapper:function(e){var n=e.children;return i.createElement(i.Fragment,{},n)}},h=i.forwardRef((function(e,n){var t=e.components,r=e.mdxType,a=e.originalType,s=e.parentName,d=l(e,["components","mdxType","originalType","parentName"]),h=p(t),m=r,g=h["".concat(s,".").concat(m)]||h[m]||u[m]||a;return t?i.createElement(g,o(o({ref:n},d),{},{components:t})):i.createElement(g,o({ref:n},d))}));function m(e,n){var t=arguments,r=n&&n.mdxType;if("string"==typeof e||r){var a=t.length,o=new Array(a);o[0]=h;var l={};for(var s in n)hasOwnProperty.call(n,s)&&(l[s]=n[s]);l.originalType=e,l.mdxType="string"==typeof e?e:r,o[1]=l;for(var p=2;p<a;p++)o[p]=t[p];return i.createElement.apply(null,o)}return i.createElement.apply(null,t)}h.displayName="MDXCreateElement"},1171(e,n,t){t.r(n),t.d(n,{assets:()=>s,contentTitle:()=>o,default:()=>u,frontMatter:()=>a,metadata:()=>l,toc:()=>p});var i=t(8168),r=(t(6540),t(5680));const a={id:"testing",title:"Testing",slug:"/workflow/testing"},o=void 0,l={unversionedId:"workflow/testing",id:"workflow/testing",title:"Testing",description:"How to test experiment definitions and branch configurations on mobile devices.",source:"@site/docs/workflow/testing.md",sourceDirName:"workflow",slug:"/workflow/testing",permalink:"/workflow/testing",draft:!1,editUrl:"https://github.com/mozilla/experimenter-docs/edit/main/docs/workflow/testing.md",tags:[],version:"current",frontMatter:{id:"testing",title:"Testing",slug:"/workflow/testing"},sidebar:"sidebar",previous:{title:"Localization",permalink:"/workflow/localization"},next:{title:"Desktop Testing",permalink:"/platform-guides/desktop/testing"}},s={},p=[{value:"Overview",id:"overview",level:2},{value:"The Annotated Guide to the Experiment Definition",id:"the-annotated-guide-to-the-experiment-definition",level:2},{value:"Changing Between Experiments",id:"changing-between-experiments",level:2},{value:"Experimenter",id:"experimenter",level:3},{value:"Client Side",id:"client-side",level:3},{value:"Alternatives to Experimenter",id:"alternatives-to-experimenter",level:2},{value:"Experiment Set-Ups for Testing Branches",id:"experiment-set-ups-for-testing-branches",level:2},{value:"Testing the Experiment Document Itself",id:"testing-the-experiment-document-itself",level:2},{value:"Conclusion",id:"conclusion",level:2}],d={toc:p};function u(e){let{components:n,...t}=e;return(0,r.yg)("wrapper",(0,i.A)({},d,t,{components:n,mdxType:"MDXLayout"}),(0,r.yg)("p",null,"How to test experiment definitions and branch configurations on mobile devices."),(0,r.yg)("p",null,"We have three parts to test:"),(0,r.yg)("ol",null,(0,r.yg)("li",{parentName:"ol"},"The experiment definition document, as defined in Experimenter and delivered by Remote Settings. Problems with this definition should be resolved by the experiment owner."),(0,r.yg)("li",{parentName:"ol"},"The Nimbus system (Nimbus client side SDK and the Experimenter/Remote Settings/Glean)"),(0,r.yg)("li",{parentName:"ol"},"How the app responds to different branches/feature configurations. Problems with the app's response to different branches should be resolved by the app's engineering team.")),(0,r.yg)("p",null,"Testing the Nimbus system is out of the scope of this document."),(0,r.yg)("p",null,"At this point, there are few if any tools for QA to use to test either of 1, or 3."),(0,r.yg)("admonition",{type:"info"},(0,r.yg)("p",{parentName:"admonition"},"Much of this document can now be considered deprecated: the manual steps below are now done for you using the ",(0,r.yg)("inlineCode",{parentName:"p"},"nimbus-cli")," tooling."),(0,r.yg)("p",{parentName:"admonition"},"Please refer to the documentation for ",(0,r.yg)("a",{parentName:"p",href:"/technical-reference/nimbus-cli/overview"},(0,r.yg)("inlineCode",{parentName:"a"},"nimbus-cli")),".")),(0,r.yg)("p",null,"However, using a local build, and by changing the ",(0,r.yg)("inlineCode",{parentName:"p"},"NIMBUS_URL")," to the Remote Settings staging server at ",(0,r.yg)("a",{parentName:"p",href:"https://firefox.settings.services.allizom.org"},"https://firefox.settings.services.allizom.org")," we can effectively vary the experiments definition document to test the app, and to replicate the experiment definition document used in production. This is ",(0,r.yg)("a",{parentName:"p",href:"https://github.com/mozilla-mobile/firefox-android/tree/main/fenix#using-nimbus-servers-during-local-development"},"documented here"),"."),(0,r.yg)("p",null,"Building Fenix locally is ",(0,r.yg)("a",{parentName:"p",href:"https://github.com/mozilla-mobile/firefox-android/tree/main/fenix#build-instructions"},"documented in the Fenix repository"),"."),(0,r.yg)("h2",{id:"overview"},"Overview"),(0,r.yg)("p",null,"We wish to get the app to ingest the experiment definition of our choice. Here is a sample experiment definition, which you can generate with the ",(0,r.yg)("a",{parentName:"p",href:"https://stage.experimenter.nonprod.webservices.mozgcp.net/nimbus/"},"staging instance of Experimenter"),"."),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre",className:"language-json"},'{\n  "data": [\n    {\n      "slug": "nimbus-aa-validation-for-ios-v2",\n      "appId": "org.mozilla.ios.FirefoxBeta",\n      "appName": "firefox_ios",\n      "channel": "beta",\n      "endDate": null,\n      "branches": [\n        {\n          "slug": "treatment",\n          "ratio": 40,\n          "feature": {\n            "value": {},\n            "enabled": true,\n            "featureId": "the-feature-id"\n          }\n        },\n        {\n          "slug": "control",\n          "ratio": 60,\n          "feature": {\n            "value": {},\n            "enabled": true,\n            "featureId": "the-feature-id"\n          }\n        }\n      ],\n      "outcomes": [],\n      "arguments": {},\n      "probeSets": [],\n      "startDate": "2021-04-19T22:40:44.614622Z",\n      "targeting": "true",\n      "featureIds": [\n        "the-feature-id"\n      ],\n      "application": "org.mozilla.ios.FirefoxBeta",\n      "bucketConfig": {\n        "count": 8000,\n        "start": 0,\n        "total": 10000,\n        "namespace": "nimbus-aa-validation-for-ios-v2-1",\n        "randomizationUnit": "nimbus_id"\n      },\n      "schemaVersion": "1.4.0",\n      "userFacingName": "A replica of the experiment under test",\n      "referenceBranch": "control",\n      "proposedDuration": 28,\n      "isEnrollmentPaused": false,\n      "proposedEnrollment": 7,\n      "userFacingDescription": "Is Nimbus working? This experiment tries to find out.",\n      "id": "nimbus-aa-validation-for-ios-v2",\n      "last_modified": 1619530368808\n    }\n  ]\n}\n')),(0,r.yg)("h2",{id:"the-annotated-guide-to-the-experiment-definition"},"The Annotated Guide to the Experiment Definition"),(0,r.yg)("p",null,"Many of the fields in the above JSON correspond to the experiment UI."),(0,r.yg)("p",null,"These fields affect which OS, app and build the experiment is for. These should align with the developer or nightly builds of the app your using, on the platform you're using. If these don't line up, the app will not pick up this experiment."),(0,r.yg)("ul",null,(0,r.yg)("li",{parentName:"ul"},(0,r.yg)("inlineCode",{parentName:"li"},"appName"),": pick ",(0,r.yg)("inlineCode",{parentName:"li"},"fenix")," or ",(0,r.yg)("inlineCode",{parentName:"li"},"firefox_ios")),(0,r.yg)("li",{parentName:"ul"},(0,r.yg)("inlineCode",{parentName:"li"},"appId"),": The experimenter UI should help you select the right one."),(0,r.yg)("li",{parentName:"ul"},(0,r.yg)("inlineCode",{parentName:"li"},"channel"),": this must be ",(0,r.yg)("inlineCode",{parentName:"li"},"nightly")," or ",(0,r.yg)("inlineCode",{parentName:"li"},"developer"),". The experimenter UI should help you select the right one."),(0,r.yg)("li",{parentName:"ul"},(0,r.yg)("inlineCode",{parentName:"li"},"feature_id"),"/",(0,r.yg)("inlineCode",{parentName:"li"},"featureIds"),": this is the identifier of the app feature under test. This should match what is hard coded into the App. Experimenter will put these in all the right places. If the feature id is not already listed, you can ","[add it here][experimenter-admin]",".")),(0,r.yg)("p",null,"These fields affect segment the population for eligibility for the experiment, and which branch they'll be given."),(0,r.yg)("ul",null,(0,r.yg)("li",{parentName:"ul"},(0,r.yg)("inlineCode",{parentName:"li"},"targeting"),": Experimenter will help you generate this JEXL query string. If Nimbus evaluates this on a given device to ",(0,r.yg)("inlineCode",{parentName:"li"},"true"),", then the device is eligible for the experiment. If your testing the app, then you (TODO)"),(0,r.yg)("li",{parentName:"ul"},(0,r.yg)("inlineCode",{parentName:"li"},"bucketConfig"),": ",(0,r.yg)("inlineCode",{parentName:"li"},"start")," ",(0,r.yg)("inlineCode",{parentName:"li"},"count")," and ",(0,r.yg)("inlineCode",{parentName:"li"},"total"),". Of the total eligible users, the proportion that will actually be enrolled in the experiment is given by ",(0,r.yg)("inlineCode",{parentName:"li"},"(count - start) / total"),". For testing purposes, you should make ",(0,r.yg)("inlineCode",{parentName:"li"},"start = 0"),", ",(0,r.yg)("inlineCode",{parentName:"li"},"count = 10000"),", ",(0,r.yg)("inlineCode",{parentName:"li"},"total = 10000"),", i.e. enroll 100% of eligible devices.")),(0,r.yg)("p",null,"If the device is enrolled in the experiment (i.e. is targeted as eligible, and in the experiment bucket), then it will be enrolled in to one of the two or more branches. Once enrolled it will not change branches."),(0,r.yg)("ul",null,(0,r.yg)("li",{parentName:"ul"},(0,r.yg)("inlineCode",{parentName:"li"},"branch")," -> ",(0,r.yg)("inlineCode",{parentName:"li"},"slug"),": This should match the branches that the app's feature responds to. In most cases, it will be ",(0,r.yg)("inlineCode",{parentName:"li"},"treatment")," and ",(0,r.yg)("inlineCode",{parentName:"li"},"control"),"."),(0,r.yg)("li",{parentName:"ul"},(0,r.yg)("inlineCode",{parentName:"li"},"branch")," -> ",(0,r.yg)("inlineCode",{parentName:"li"},"ratio"),": The ",(0,r.yg)("inlineCode",{parentName:"li"},"ratio")," property of each branch, gives the proportion of the enrolled population will get a particular branch. Tip: make your ratios add up to 100. In the above example, the ",(0,r.yg)("inlineCode",{parentName:"li"},"control")," branch gets 60 out of every (60 + 40) enrollments, i.e. 60%.")),(0,r.yg)("h2",{id:"changing-between-experiments"},"Changing Between Experiments"),(0,r.yg)("p",null,"To test the app's behaviour in the face of the branches, you'll need one experiment per branch. Each experiment needs the same feature id. They cannot be run in parallel."),(0,r.yg)("h3",{id:"experimenter"},"Experimenter"),(0,r.yg)("p",null,"The experiment can be ended remotely."),(0,r.yg)("h3",{id:"client-side"},"Client Side"),(0,r.yg)("p",null,"Once enrolled in an experiment, the user should not be able to enroll in a different branch."),(0,r.yg)("p",null,"Once the experiment has been ended, you can reset the app by clearing app data and caches. The experiment is downloaded on first run after the reset or install, after a few second; and the experiment enrollment will happen on second run."),(0,r.yg)("h2",{id:"alternatives-to-experimenter"},"Alternatives to Experimenter"),(0,r.yg)("p",null,"It may not be desirable to use Experimenter: you should be able to set up a simple file server on your network. It should be able to serve the experiment JSON file directly, which you can edit the JSON directly."),(0,r.yg)("p",null,"This local server should serve the file from the path: ",(0,r.yg)("inlineCode",{parentName:"p"},"/buckets/main/collections/nimbus-mobile-experiments/records"),". Setting the ",(0,r.yg)("inlineCode",{parentName:"p"},"NIMBUS_URL")," to this local server should be done in the same way as above."),(0,r.yg)("h2",{id:"experiment-set-ups-for-testing-branches"},"Experiment Set-Ups for Testing Branches"),(0,r.yg)("p",null,"You should have one experiment per branch:"),(0,r.yg)("ul",null,(0,r.yg)("li",{parentName:"ul"},"they should  have ",(0,r.yg)("inlineCode",{parentName:"li"},"targeting")," = ",(0,r.yg)("inlineCode",{parentName:"li"},'"true"'),", ",(0,r.yg)("inlineCode",{parentName:"li"},"bucketConfig")," to have ",(0,r.yg)("inlineCode",{parentName:"li"},"start")," = ",(0,r.yg)("inlineCode",{parentName:"li"},"0"),", ",(0,r.yg)("inlineCode",{parentName:"li"},"total = 10000")," and ",(0,r.yg)("inlineCode",{parentName:"li"},"count = 10000"),"."),(0,r.yg)("li",{parentName:"ul"},"For the branch under test, set the branch ",(0,r.yg)("inlineCode",{parentName:"li"},"ratio")," to ",(0,r.yg)("inlineCode",{parentName:"li"},"100")," and the others to ",(0,r.yg)("inlineCode",{parentName:"li"},"0"),".")),(0,r.yg)("p",null,"This will ensure that all clients that load the experiment will enroll in it and choose that exact branch."),(0,r.yg)("h2",{id:"testing-the-experiment-document-itself"},"Testing the Experiment Document Itself"),(0,r.yg)("p",null,"The only thing you can test on small scale is the targeting string. You should make an experiment with the same targeting as the experiment brief. You should ensure every client enrolls in a branch which has visible changes (e.g. ",(0,r.yg)("inlineCode",{parentName:"p"},"treatment"),")."),(0,r.yg)("p",null,"You can then vary the device (e.g. the locale or language), or by using a small range of phones of different sizes and operating system versions."),(0,r.yg)("h2",{id:"conclusion"},"Conclusion"),(0,r.yg)("p",null,"Much of these will be ameliorated by testing tooling. We appreciate that the current situation is less than ideal."))}u.isMDXComponent=!0}}]);