"use strict";(self.webpackChunkexperimenter_docs=self.webpackChunkexperimenter_docs||[]).push([[3363],{4137:(e,t,n)=>{n.d(t,{Zo:()=>u,kt:()=>m});var r=n(7294);function l(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function a(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?a(Object(n),!0).forEach((function(t){l(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):a(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,r,l=function(e,t){if(null==e)return{};var n,r,l={},a=Object.keys(e);for(r=0;r<a.length;r++)n=a[r],t.indexOf(n)>=0||(l[n]=e[n]);return l}(e,t);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);for(r=0;r<a.length;r++)n=a[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(l[n]=e[n])}return l}var o=r.createContext({}),p=function(e){var t=r.useContext(o),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},u=function(e){var t=p(e.components);return r.createElement(o.Provider,{value:t},e.children)},f="mdxType",c={inlineCode:"code",wrapper:function(e){var t=e.children;return r.createElement(r.Fragment,{},t)}},d=r.forwardRef((function(e,t){var n=e.components,l=e.mdxType,a=e.originalType,o=e.parentName,u=s(e,["components","mdxType","originalType","parentName"]),f=p(n),d=l,m=f["".concat(o,".").concat(d)]||f[d]||c[d]||a;return n?r.createElement(m,i(i({ref:t},u),{},{components:n})):r.createElement(m,i({ref:t},u))}));function m(e,t){var n=arguments,l=t&&t.mdxType;if("string"==typeof e||l){var a=n.length,i=new Array(a);i[0]=d;var s={};for(var o in t)hasOwnProperty.call(t,o)&&(s[o]=t[o]);s.originalType=e,s[f]="string"==typeof e?e:l,i[1]=s;for(var p=2;p<a;p++)i[p]=n[p];return r.createElement.apply(null,i)}return r.createElement.apply(null,n)}d.displayName="MDXCreateElement"},4166:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>o,contentTitle:()=>i,default:()=>c,frontMatter:()=>a,metadata:()=>s,toc:()=>p});var r=n(7462),l=(n(7294),n(4137));const a={id:"desktop-pref-experiments",title:"Running Pref-setting Experiments on Desktop",slug:"/desktop-pref-experiments"},i=void 0,s={unversionedId:"deep-dives/desktop/desktop-pref-experiments",id:"deep-dives/desktop/desktop-pref-experiments",title:"Running Pref-setting Experiments on Desktop",description:"test",source:"@site/docs/deep-dives/desktop/desktop-pref-experiments.md",sourceDirName:"deep-dives/desktop",slug:"/desktop-pref-experiments",permalink:"/desktop-pref-experiments",draft:!1,editUrl:"https://github.com/mozilla/experimenter-docs/edit/main/docs/deep-dives/desktop/desktop-pref-experiments.md",tags:[],version:"current",frontMatter:{id:"desktop-pref-experiments",title:"Running Pref-setting Experiments on Desktop",slug:"/desktop-pref-experiments"},sidebar:"sidebar",previous:{title:"Launching Incident Response Pref Flips",permalink:"/desktop-incident-response"},next:{title:"Desktop Targeting debug",permalink:"/desktop-targeting-debug"}},o={},p=[{value:"Example Feature",id:"example-feature",level:2},{value:"Experiments vs Rollouts",id:"experiments-vs-rollouts",level:2},{value:"Pref branches",id:"pref-branches",level:2},{value:"User Preference Changes",id:"user-preference-changes",level:2},{value:"Manifest Changes",id:"manifest-changes",level:2},{value:"Restrictions with Fallback Prefs",id:"restrictions-with-fallback-prefs",level:2},{value:"Conflicts with Incident Response Pref Flips",id:"conflicts-with-incident-response-pref-flips",level:2}],u={toc:p},f="wrapper";function c(e){let{components:t,...n}=e;return(0,l.kt)(f,(0,r.Z)({},u,n,{components:t,mdxType:"MDXLayout"}),(0,l.kt)("p",null,(0,l.kt)("a",{parentName:"p",href:"/desktop-incident-response"},"test")),(0,l.kt)("p",null,"As of Firefox 107, Nimbus supports experiments that set preferences on Desktop.\nUnlike Normandy, Nimbus cannot set arbitrary preferences; instead, the\npreferences that may be set are determined by the feature manifest."),(0,l.kt)("p",null,"Each variable in a Nimbus feature can set a single pref of any type."),(0,l.kt)("p",null,"NB: Support for JSON variables was added in Firefox 126. The value of the pref\nwill be ",(0,l.kt)("inlineCode",{parentName:"p"},"JSON.stringify(value)"),"."),(0,l.kt)("h2",{id:"example-feature"},"Example Feature"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-yaml"},"my-feature:\n  description: A description of my feature\n  owner: whoami@mozilla.com\n  hasExposure: false\n  variables:\n    enabled:\n      description: A variable setting a boolean pref to enable a feature.\n      type: boolean\n      setPref:\n        branch: user\n        pref: my_feature.enabled\n    name:\n      description: A variable setting a string pref to determine some name.\n      type: string\n      setPref:\n        branch: user\n        pref: my_feature.name\n    count:\n      description: A variable setting an integer pref to determine some count.\n      type: int\n      setPref:\n        branch: default\n        pref: my_feature.count\n")),(0,l.kt)("h2",{id:"experiments-vs-rollouts"},"Experiments vs Rollouts"),(0,l.kt)("p",null,"Users can be enrolled in an experiment and rollout for the same feature. If both\nan experiment and rollout set a variable that sets a pref, then the experiment\nwill take precedence. If the user unenrolls from the experiment, then the pref\nwill be set to the value specified in the rollout."),(0,l.kt)("p",null,"When the user is no longer enrolled in either an experiment or a rollout setting\na given pref, then it will be reset to its original value at the time of the\nfirst enrollment, with some caveats:"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},"If the pref is set on the default branch (see ",(0,l.kt)("a",{parentName:"li",href:"#pref-branches"},"below"),") and the\npref was not set before enrollment, then the pref will not change until the\nnext restart. This is due to a technical limitation: default branch values\ncannot be cleared."),(0,l.kt)("li",{parentName:"ul"},"If the pref is set on the user branch and the pref was not set before\nenrollment, then the pref will be cleared and will be no longer available.")),(0,l.kt)("h2",{id:"pref-branches"},"Pref branches"),(0,l.kt)("p",null,"Each variable using ",(0,l.kt)("inlineCode",{parentName:"p"},"setPref")," must specify which branch will be written to.\nThe default branch is not persisted, so prefs set on the default branch will not\nbe available until Nimbus completes its startup and loads all its active\nexperiments from disk."),(0,l.kt)("h2",{id:"user-preference-changes"},"User Preference Changes"),(0,l.kt)("p",null,"If a user is enrolled in an experiment or rollout that sets a pref and that pref\nchanges, the user will be unenrolled from the experiment (or rollout). This\nincludes both changes made by the user and changes in code. Experiment runners\nshould be careful to ensure there is no code in tree that will modify prefs they\nare experimenting on, otherwise their populations may get spuriously unenrolled."),(0,l.kt)("p",null,"The new value of the preference will be persisted."),(0,l.kt)("h2",{id:"manifest-changes"},"Manifest Changes"),(0,l.kt)("p",null,"Some changes to the feature manifest may result in unenrollment from an active\nexperiment:"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},"The feature being removed."),(0,l.kt)("li",{parentName:"ul"},"A variable that is currently setting a pref is removed."),(0,l.kt)("li",{parentName:"ul"},"A variable that is currently setting a pref either changes the pref it is\nsetting or no longer sets a pref (i.e., its ",(0,l.kt)("inlineCode",{parentName:"li"},"setPref")," value changes or is\nremoved).")),(0,l.kt)("p",null,"It should be noted that unenrollment for these reasons will only occur when the\nuser is enrolled in a pref-setting experiment. If a feature specifies both\npref-setting and non-pref setting variables, then changes to the manifest will\nnot result in unenrollment if the active experiment does not have any values for\npref-setting variables."),(0,l.kt)("h2",{id:"restrictions-with-fallback-prefs"},"Restrictions with Fallback Prefs"),(0,l.kt)("p",null,"Variables may not specify both a ",(0,l.kt)("inlineCode",{parentName:"p"},"fallbackPref")," and a ",(0,l.kt)("inlineCode",{parentName:"p"},"setPref"),"."),(0,l.kt)("p",null,"Fallback prefs and set prefs are mutually exclusive. That is, If any variable in\nany feature specifies a pref as a fallback pref, no variable may set that\nvariable as a set pref and vice versa."),(0,l.kt)("p",null,"These restrictions are enforced at build time."),(0,l.kt)("h2",{id:"conflicts-with-incident-response-pref-flips"},"Conflicts with Incident Response Pref Flips"),(0,l.kt)("p",null,"If a user is enrolled in a setPref experiment/rollout and then enrolls in an\n",(0,l.kt)("a",{parentName:"p",href:"/desktop-incident-response"},"incident response pref flip"),", they will be unenrolled from the\nsetPref experiment/rollout. This will result in an unenrollment event\n(",(0,l.kt)("a",{parentName:"p",href:"https://dictionary.telemetry.mozilla.org/apps/firefox_desktop/metrics/nimbus_events_unenrollment"},"glean"),", ",(0,l.kt)("a",{parentName:"p",href:"https://probes.telemetry.mozilla.org/?search=unenroll&view=detail&probeId=event%2Fnormandy.unenroll%23unenroll"},"legacy"),") being submitted with the\nfollowing data:"),(0,l.kt)("table",null,(0,l.kt)("thead",null,(0,l.kt)("tr",null,(0,l.kt)("th",null,"Glean Field"),(0,l.kt)("th",null,"Legacy Field"),(0,l.kt)("th",null,"Description"))),(0,l.kt)("tbody",null,(0,l.kt)("tr",null,(0,l.kt)("td",null,(0,l.kt)("code",null,"reason")),(0,l.kt)("td",null,(0,l.kt)("code",null,"reason")),(0,l.kt)("td",null,"The string ",(0,l.kt)("code",null,'"prefFlips-conflict"'))),(0,l.kt)("tr",null,(0,l.kt)("td",null,(0,l.kt)("code",null,"conflicting_slug")),(0,l.kt)("td",null,(0,l.kt)("code",null,"conflictingSlug")),(0,l.kt)("td",null,"The slug of the experiment that caused the unenrollment.")))))}c.isMDXComponent=!0}}]);