"use strict";(globalThis.webpackChunkexperimenter_docs=globalThis.webpackChunkexperimenter_docs||[]).push([[9880],{5680(e,n,i){i.d(n,{xA:()=>g,yg:()=>c});var t=i(6540);function a(e,n,i){return n in e?Object.defineProperty(e,n,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[n]=i,e}function r(e,n){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var t=Object.getOwnPropertySymbols(e);n&&(t=t.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),i.push.apply(i,t)}return i}function o(e){for(var n=1;n<arguments.length;n++){var i=null!=arguments[n]?arguments[n]:{};n%2?r(Object(i),!0).forEach((function(n){a(e,n,i[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):r(Object(i)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(i,n))}))}return e}function l(e,n){if(null==e)return{};var i,t,a=function(e,n){if(null==e)return{};var i,t,a={},r=Object.keys(e);for(t=0;t<r.length;t++)i=r[t],n.indexOf(i)>=0||(a[i]=e[i]);return a}(e,n);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(t=0;t<r.length;t++)i=r[t],n.indexOf(i)>=0||Object.prototype.propertyIsEnumerable.call(e,i)&&(a[i]=e[i])}return a}var s=t.createContext({}),p=function(e){var n=t.useContext(s),i=n;return e&&(i="function"==typeof e?e(n):o(o({},n),e)),i},g=function(e){var n=p(e.components);return t.createElement(s.Provider,{value:n},e.children)},d={inlineCode:"code",wrapper:function(e){var n=e.children;return t.createElement(t.Fragment,{},n)}},m=t.forwardRef((function(e,n){var i=e.components,a=e.mdxType,r=e.originalType,s=e.parentName,g=l(e,["components","mdxType","originalType","parentName"]),m=p(i),c=a,u=m["".concat(s,".").concat(c)]||m[c]||d[c]||r;return i?t.createElement(u,o(o({ref:n},g),{},{components:i})):t.createElement(u,o({ref:n},g))}));function c(e,n){var i=arguments,a=n&&n.mdxType;if("string"==typeof e||a){var r=i.length,o=new Array(r);o[0]=m;var l={};for(var s in n)hasOwnProperty.call(n,s)&&(l[s]=n[s]);l.originalType=e,l.mdxType="string"==typeof e?e:a,o[1]=l;for(var p=2;p<r;p++)o[p]=i[p];return t.createElement.apply(null,o)}return t.createElement.apply(null,i)}m.displayName="MDXCreateElement"},5736(e,n,i){i.r(n),i.d(n,{assets:()=>s,contentTitle:()=>o,default:()=>d,frontMatter:()=>r,metadata:()=>l,toc:()=>p});var t=i(8168),a=(i(6540),i(5680));const r={id:"population-sizing",title:"Population Sizing",slug:"/advanced/population-sizing",sidebar_position:3},o=void 0,l={unversionedId:"advanced/population-sizing",id:"advanced/population-sizing",title:"Population Sizing",description:"Population sizing can be estimated using targeting context metrics available for Firefox on Desktop, iOS, and Android. Fields needed to translate Advanced Targeting expressions may not be fully available for all platforms.",source:"@site/docs/advanced/population-sizing.md",sourceDirName:"advanced",slug:"/advanced/population-sizing",permalink:"/advanced/population-sizing",draft:!1,editUrl:"https://github.com/mozilla/experimenter-docs/edit/main/docs/advanced/population-sizing.md",tags:[],version:"current",sidebarPosition:3,frontMatter:{id:"population-sizing",title:"Population Sizing",slug:"/advanced/population-sizing",sidebar_position:3},sidebar:"sidebar",previous:{title:"Advanced Targeting",permalink:"/advanced/custom-audiences"},next:{title:"Behavioral Targeting",permalink:"/advanced/behavioral-targeting"}},s={},p=[{value:"Accuracy",id:"accuracy",level:3},{value:"Estimating for Desktop",id:"estimating-for-desktop",level:3},{value:"Translating Desktop Targeting Expressions from JEXL to SQL",id:"translating-desktop-targeting-expressions-from-jexl-to-sql",level:4},{value:"Estimating for Firefox on Android and iOS",id:"estimating-for-firefox-on-android-and-ios",level:3},{value:"Translating Android and iOS Targeting Expressions from JEXL to SQL",id:"translating-android-and-ios-targeting-expressions-from-jexl-to-sql",level:4}],g={toc:p};function d(e){let{components:n,...i}=e;return(0,a.yg)("wrapper",(0,t.A)({},g,i,{components:n,mdxType:"MDXLayout"}),(0,a.yg)("p",null,"Population sizing can be estimated using targeting context metrics available for Firefox on Desktop, iOS, and Android. Fields needed to translate Advanced Targeting expressions may not be fully available for all platforms."),(0,a.yg)("admonition",{title:"context",type:"info"},(0,a.yg)("p",{parentName:"admonition"},"This page covers how to estimate the number of clients that match a particular targeting expression, not how to decide how many enrolled clients an experiment might need.")),(0,a.yg)("h3",{id:"accuracy"},"Accuracy"),(0,a.yg)("p",null,"Population sizing accuracy of the queries below was investigated in ",(0,a.yg)("a",{parentName:"p",href:"https://mozilla-hub.atlassian.net/browse/EXP-6101"},"EXP-6101"),", and the ",(0,a.yg)("inlineCode",{parentName:"p"},"(estimated population from preceding week)/(observed population)")," ratios were in the following ranges for recent experiments run on Firefox versions that had been out for at least one week:"),(0,a.yg)("ul",null,(0,a.yg)("li",{parentName:"ul"},"Desktop: 0.9-1.3, average 1.163"),(0,a.yg)("li",{parentName:"ul"},"Android: 1.02-1.21, average 1.136"),(0,a.yg)("li",{parentName:"ul"},"iOS: 1.35-1.53, average 1.448")),(0,a.yg)("p",null,"This means that Desktop estimates were up to +30% larger than observed enrollments, Android estimates were up to 21% larger than observed enrollments, iOS estimates were up to 53% larger than observed enrollments, so estimates may need to be adjusted accordingly to ensure sufficient minimum populations."),(0,a.yg)("h3",{id:"estimating-for-desktop"},"Estimating for Desktop"),(0,a.yg)("p",null,"The following query can be used to estimate available population for Firefox Desktop, if not using Redash then ",(0,a.yg)("inlineCode",{parentName:"p"},"{{ sql_targeting_expression }}")," should be replaced with the actual sql expression:"),(0,a.yg)("p",null,(0,a.yg)("a",{parentName:"p",href:"https://sql.telemetry.mozilla.org/queries/112917?p_sql_targeting_expression=TRUE"},"Desktop Redash Query")),(0,a.yg)("pre",null,(0,a.yg)("code",{parentName:"pre",className:"language-sql"},"SELECT\n  COUNT(DISTINCT metrics.uuid.legacy_telemetry_profile_group_id) AS available_weekly_population,\nFROM\n  `mozdata.firefox_desktop.nimbus_targeting_context`\nWHERE\n  DATE(submission_timestamp) BETWEEN CURRENT_DATE - 7 AND CURRENT_DATE - 1\n  AND ({{ sql_targeting_expression }})\n")),(0,a.yg)("p",null,"This is available as a templated query in Redash: ",(0,a.yg)("a",{parentName:"p",href:"https://sql.telemetry.mozilla.org/queries/112917?p_sql_targeting_expression=TRUE"},"https://sql.telemetry.mozilla.org/queries/112917?p_sql_targeting_expression=TRUE")),(0,a.yg)("h4",{id:"translating-desktop-targeting-expressions-from-jexl-to-sql"},"Translating Desktop Targeting Expressions from JEXL to SQL"),(0,a.yg)("p",null,"To determine the SQL targeting expression for a given experiment, first get the full targeting expression from the Audience section, which is in JEXL format. A simple targeting expression might look like this:"),(0,a.yg)("pre",null,(0,a.yg)("code",{parentName:"pre"},"(browserSettings.update.channel in [\"release\"]) && (version|versionCompare('140.!') >= 0) && (locale in ['en-CA', 'en-GB', 'en-US']) && (region == 'US')\n")),(0,a.yg)("p",null,"Translating one condition at a time:"),(0,a.yg)("ul",null,(0,a.yg)("li",{parentName:"ul"},(0,a.yg)("inlineCode",{parentName:"li"},"browserSettings.update.channel")," is available as ",(0,a.yg)("inlineCode",{parentName:"li"},"normalized_channel"),", so ",(0,a.yg)("inlineCode",{parentName:"li"},'browserSettings.update.channel in ["release"]')," could be translated as ",(0,a.yg)("inlineCode",{parentName:"li"},'normalized_channel = "release"')),(0,a.yg)("li",{parentName:"ul"},"When comparing only the major version, it's available as ",(0,a.yg)("inlineCode",{parentName:"li"},"metrics.quantity.nimbus_targeting_context_firefox_version"),", so ",(0,a.yg)("inlineCode",{parentName:"li"},"(version|versionCompare('140.!') >= 0)")," could be translated as ",(0,a.yg)("inlineCode",{parentName:"li"},"metrics.quantity.nimbus_targeting_context_firefox_version >= 140"),(0,a.yg)("ul",{parentName:"li"},(0,a.yg)("li",{parentName:"ul"},"The full version is available as ",(0,a.yg)("inlineCode",{parentName:"li"},"metrics.string.nimbus_targeting_context_version"),", so it could alternatively be translated as ",(0,a.yg)("inlineCode",{parentName:"li"},'mozfun.norm.extract_version(metrics.string.nimbus_targeting_context_version, "major") >= 140')))),(0,a.yg)("li",{parentName:"ul"},(0,a.yg)("inlineCode",{parentName:"li"},"locale")," is available as ",(0,a.yg)("inlineCode",{parentName:"li"},"metrics.string.nimbus_targeting_context_locale"),", and ",(0,a.yg)("inlineCode",{parentName:"li"},"[]")," should be converted to ",(0,a.yg)("inlineCode",{parentName:"li"},"()")," for BigQuery SQL ",(0,a.yg)("inlineCode",{parentName:"li"},"IN")," expressions, so ",(0,a.yg)("inlineCode",{parentName:"li"},"locale in ['en-CA', 'en-GB', 'en-US']")," could be translated as ",(0,a.yg)("inlineCode",{parentName:"li"},"metrics.string.nimbus_targeting_context_locale IN ('en-CA', 'en-GB', 'en-US')")),(0,a.yg)("li",{parentName:"ul"},"region is available as ",(0,a.yg)("inlineCode",{parentName:"li"},"metrics.string.nimbus_targeting_context_region"),", and SQL uses a single ",(0,a.yg)("inlineCode",{parentName:"li"},"=")," for equality comparison, so ",(0,a.yg)("inlineCode",{parentName:"li"},"region == 'US'")," could be translated as ",(0,a.yg)("inlineCode",{parentName:"li"},"metrics.string.nimbus_targeting_context_region = 'US'")),(0,a.yg)("li",{parentName:"ul"},(0,a.yg)("inlineCode",{parentName:"li"},"=="),", ",(0,a.yg)("inlineCode",{parentName:"li"},"&&"),", ",(0,a.yg)("inlineCode",{parentName:"li"},"||"),", and ",(0,a.yg)("inlineCode",{parentName:"li"},"!")," translate to ",(0,a.yg)("inlineCode",{parentName:"li"},"="),", ",(0,a.yg)("inlineCode",{parentName:"li"},"AND"),", ",(0,a.yg)("inlineCode",{parentName:"li"},"OR"),", and ",(0,a.yg)("inlineCode",{parentName:"li"},"NOT")," respectively")),(0,a.yg)("p",null,"So the SQL version of the targeting expression for Desktop could be:"),(0,a.yg)("pre",null,(0,a.yg)("code",{parentName:"pre",className:"language-sql"},"(normalized_channel = \"release\")\nAND (metrics.quantity.nimbus_targeting_context_firefox_version >= 140)\nAND (metrics.string.nimbus_targeting_context_locale IN ('en-CA', 'en-GB', 'en-US'))\nAND (metrics.string.nimbus_targeting_context_region = 'US')\n")),(0,a.yg)("admonition",{type:"warning"},(0,a.yg)("p",{parentName:"admonition"},(0,a.yg)("inlineCode",{parentName:"p"},"NOT")," has a different operator precedence in BigQuery than ",(0,a.yg)("inlineCode",{parentName:"p"},"!")," in JEXL, so ",(0,a.yg)("inlineCode",{parentName:"p"},"NOT")," should always be used inside a ",(0,a.yg)("inlineCode",{parentName:"p"},"()")," with a single expression for clarity. For example ",(0,a.yg)("inlineCode",{parentName:"p"},"!isMac && isFxAEnabled")," must be translated as ",(0,a.yg)("inlineCode",{parentName:"p"},"(NOT BOOL(metrics.object.nimbus_targeting_context_os.isMac)) AND metrics.boolean.nimbus_targeting_context_is_fx_a_enabled"))),(0,a.yg)("p",null,"The Glean dictionary can be searched for ",(0,a.yg)("a",{parentName:"p",href:"https://dictionary.telemetry.mozilla.org/apps/firefox_desktop?page=1&search=nimbus_targeting"},"available fields in Firefox Desktop")),(0,a.yg)("h3",{id:"estimating-for-firefox-on-android-and-ios"},"Estimating for Firefox on Android and iOS"),(0,a.yg)("p",null,"The following queries can be used to estimate available population for release channel experiments on Android and iOS, if not using Redash then ",(0,a.yg)("inlineCode",{parentName:"p"},"{{ sql_targeting_expression }}")," should be replaced with the actual sql expression:"),(0,a.yg)("p",null,"For Android release channel:"),(0,a.yg)("p",null,(0,a.yg)("a",{parentName:"p",href:"https://sql.telemetry.mozilla.org/queries/112918?p_sql_targeting_expression=TRUE"},"Android Redash Query")),(0,a.yg)("pre",null,(0,a.yg)("code",{parentName:"pre",className:"language-sql"},"SELECT\n  COUNT(DISTINCT client_info.client_id) AS available_weekly_population,\nFROM\n  `mozdata.fenix.nimbus`\nWHERE\n  DATE(submission_timestamp) BETWEEN CURRENT_DATE - 7 AND CURRENT_DATE - 1\n  AND ({{ sql_targeting_expression }})\n")),(0,a.yg)("p",null,"For iOS release the table is ",(0,a.yg)("inlineCode",{parentName:"p"},"mozdata.firefox_ios.nimbus"),":"),(0,a.yg)("p",null,(0,a.yg)("a",{parentName:"p",href:"https://sql.telemetry.mozilla.org/queries/112919?p_sql_targeting_expression=TRUE"},"iOS Redash Query")),(0,a.yg)("pre",null,(0,a.yg)("code",{parentName:"pre",className:"language-sql"},"SELECT\n  COUNT(DISTINCT client_info.client_id) AS available_weekly_population,\nFROM\n  `mozdata.firefox_ios.nimbus`\nWHERE\n  DATE(submission_timestamp) BETWEEN CURRENT_DATE - 7 AND CURRENT_DATE - 1\n  AND ({{ sql_targeting_expression }})\n")),(0,a.yg)("h4",{id:"translating-android-and-ios-targeting-expressions-from-jexl-to-sql"},"Translating Android and iOS Targeting Expressions from JEXL to SQL"),(0,a.yg)("p",null,"To determine the SQL targeting expression for a given experiment, first get the full targeting expression from the Audience section, which is in JEXL format. A simple targeting expression might look like this:"),(0,a.yg)("pre",null,(0,a.yg)("code",{parentName:"pre"},"((is_already_enrolled) || ((isFirstRun == 'true') && (app_version|versionCompare('146.!') >= 0)))\n")),(0,a.yg)("p",null,"Firefox for Android and iOS have the targeting context available through the JSON field ",(0,a.yg)("inlineCode",{parentName:"p"},"metrics.object.nimbus_system_recorded_nimbus_context"),", and can be converted into SQL types using ",(0,a.yg)("a",{parentName:"p",href:"https://docs.cloud.google.com/bigquery/docs/reference/standard-sql/json_functions"},"BigQuery JSON functions"),", especially the converters ",(0,a.yg)("inlineCode",{parentName:"p"},"BOOL"),", ",(0,a.yg)("inlineCode",{parentName:"p"},"FLOAT64"),", ",(0,a.yg)("inlineCode",{parentName:"p"},"INT64"),", and ",(0,a.yg)("inlineCode",{parentName:"p"},"STRING"),", the ",(0,a.yg)("inlineCode",{parentName:"p"},"LAZY_")," prefixed lax converts, and ",(0,a.yg)("inlineCode",{parentName:"p"},"JSON_QUERY_ARRAY")," and ",(0,a.yg)("inlineCode",{parentName:"p"},"JSON_VALUE_ARRAY")," which return ",(0,a.yg)("inlineCode",{parentName:"p"},"ARRAY<JSON>")," and ",(0,a.yg)("inlineCode",{parentName:"p"},"ARRAY<STRING>")," respectively."),(0,a.yg)("admonition",{title:"context",type:"info"},(0,a.yg)("p",{parentName:"admonition"},"As of Firefox for Android 146 and Firefox for iOS 145 object keys are ",(0,a.yg)("inlineCode",{parentName:"p"},"snake_case"),", but before that they were ",(0,a.yg)("inlineCode",{parentName:"p"},"camelCase")," due to ",(0,a.yg)("a",{parentName:"p",href:"https://bugzilla.mozilla.org/show_bug.cgi?id=1931891"},"Bug 1931891"),".")),(0,a.yg)("p",null,"Translating one condition at a time:"),(0,a.yg)("ul",null,(0,a.yg)("li",{parentName:"ul"},(0,a.yg)("inlineCode",{parentName:"li"},"is_already_enrolled")," should be omitted"),(0,a.yg)("li",{parentName:"ul"},(0,a.yg)("inlineCode",{parentName:"li"},"isFirstRun")," could be translated as ",(0,a.yg)("inlineCode",{parentName:"li"},"BOOL(metrics.object.nimbus_system_recorded_nimbus_context.is_first_run)")),(0,a.yg)("li",{parentName:"ul"},(0,a.yg)("inlineCode",{parentName:"li"},"app_version|versionCompare('146.!') >= 0")," could be translated as ",(0,a.yg)("inlineCode",{parentName:"li"},'mozfun.norm.extract_version(STRING(metrics.object.nimbus_system_recorded_nimbus_context.appVersion), "major") >= 146'))),(0,a.yg)("p",null,"So the SQL version of the targeting expression could be:"),(0,a.yg)("pre",null,(0,a.yg)("code",{parentName:"pre",className:"language-SQL"},'BOOL(metrics.object.nimbus_system_recorded_nimbus_context.is_first_run)\nAND mozfun.norm.extract_version(STRING(metrics.object.nimbus_system_recorded_nimbus_context.app_version), "major") >= 146\n')),(0,a.yg)("admonition",{type:"warning"},(0,a.yg)("p",{parentName:"admonition"},(0,a.yg)("inlineCode",{parentName:"p"},"NOT")," has a different operator precedence in BigQuery than ",(0,a.yg)("inlineCode",{parentName:"p"},"!")," in JEXL, so ",(0,a.yg)("inlineCode",{parentName:"p"},"NOT")," should always be used inside a ",(0,a.yg)("inlineCode",{parentName:"p"},"()")," with a single expression for clarity. For example ",(0,a.yg)("inlineCode",{parentName:"p"},"!isMac && isFxAEnabled")," must be translated as ",(0,a.yg)("inlineCode",{parentName:"p"},"(NOT BOOL(metrics.object.nimbus_targeting_context_os.isMac)) AND metrics.boolean.nimbus_targeting_context_is_fx_a_enabled"))),(0,a.yg)("p",null,"The Glean dictionary contains additional info about the ",(0,a.yg)("inlineCode",{parentName:"p"},"nimbus_system.recorded_nimbus_context")," metric ",(0,a.yg)("a",{parentName:"p",href:"https://dictionary.telemetry.mozilla.org/apps/fenix/metrics/nimbus_system_recorded_nimbus_context"},"in Firefox for Android")," and ",(0,a.yg)("a",{parentName:"p",href:"https://dictionary.telemetry.mozilla.org/apps/firefox_ios/metrics/nimbus_system_recorded_nimbus_context"},"in Firefox for iOS"),". The Source link on those pages leads to the metric definition in ",(0,a.yg)("inlineCode",{parentName:"p"},"metrics.yaml"),", which includes a JSONSchema definition of available object keys and types."))}d.isMDXComponent=!0}}]);