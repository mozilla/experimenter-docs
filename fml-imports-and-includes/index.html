<!doctype html>
<html class="docs-version-current" lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.6">
<link rel="search" type="application/opensearchdescription+xml" title="Experimenter Docs" href="/opensearch.xml"><title data-react-helmet="true">Componentizing the Nimbus Feature Manifest | Experimenter Docs</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:url" content="https://experimenter.info/fml-imports-and-includes"><meta data-react-helmet="true" name="docsearch:language" content="en"><meta data-react-helmet="true" name="docsearch:version" content="current"><meta data-react-helmet="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="Componentizing the Nimbus Feature Manifest | Experimenter Docs"><meta data-react-helmet="true" name="description" content="Currently the nimbus-fml tooling is only able to work on one file at a time."><meta data-react-helmet="true" property="og:description" content="Currently the nimbus-fml tooling is only able to work on one file at a time."><link data-react-helmet="true" rel="shortcut icon" href="/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://experimenter.info/fml-imports-and-includes"><link data-react-helmet="true" rel="alternate" href="https://experimenter.info/fml-imports-and-includes" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://experimenter.info/fml-imports-and-includes" hreflang="x-default"><link data-react-helmet="true" rel="preconnect" href="https://BH4D9OD16A-dsn.algolia.net" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/styles.4e4a976a.css">
<link rel="preload" href="/assets/js/runtime~main.209e946f.js" as="script">
<link rel="preload" href="/assets/js/main.1ade32ac.js" as="script">
</head>
<body>
<script>!function(){function e(e){document.documentElement.setAttribute("data-theme",e)}var t=function(){var e=null;try{e=localStorage.getItem("theme")}catch(e){}return e}();null!==t?e(t):window.matchMedia("(prefers-color-scheme: dark)").matches?e("dark"):(window.matchMedia("(prefers-color-scheme: light)").matches,e("light"))}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_1oUP">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><img src="/img/logo.svg" alt="Experimenter Logo" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/img/logo-dark.svg" alt="Experimenter Logo" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"><b class="navbar__title">Mozilla Experimentation and Feature Delivery</b></a></div><div class="navbar__items navbar__items--right"><a href="https://experimenter.services.mozilla.com/nimbus/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>Nimbus<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><a href="https://mana.mozilla.org/wiki/display/FJT/Project+Nimbus" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>Mana<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><a href="https://github.com/mozilla/experimenter-docs" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-github-link" aria-label="GitHub repository"></a><div class="searchBox_1Doo"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docs-wrapper docs-doc-page"><div class="docPage_31aa"><button class="clean-btn backToTopButton_35hR" type="button"><svg viewBox="0 0 24 24" width="28"><path d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z" fill="currentColor"></path></svg></button><aside class="docSidebarContainer_3Kbt"><div class="sidebar_15mo"><nav class="menu thin-scrollbar menu_Bmed menuWithAnnouncementBar_2WvA"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Welcome</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">What&#x27;s Newsletter</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Getting Started</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Experimentation Workflow</a></li><li class="theme-doc-sidebar-item-category menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#">Deep Dives</a><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">Jetstream</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">Data topics</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">Desktop topics</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">Mobile topics</a></li><li class="theme-doc-sidebar-item-category menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#" tabindex="0">Specifications</a><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/client-sdk-states-and-lifecycle">Client SDK States &amp; Lifecycle</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/fm-unimplemented-spec">Proposed changes for Feature Manifest Language</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/fml-front-end-format">Feature Manifest Language Front-end Format As YAML</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/fml-imports-and-includes">Componentizing the Nimbus Feature Manifest</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/fml-spec">The Feature Manifest Language spec</a></li></ul></li></ul></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Experimentation Cookbook</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Additional Links</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Frequently Asked Questions</a></li></ul></nav><button type="button" title="Collapse sidebar" aria-label="Collapse sidebar" class="button button--secondary button--outline collapseSidebarButton_1CGd"><svg width="20" height="20" aria-hidden="true" class="collapseSidebarButtonIcon_3E-R"><g fill="#7a7a7a"><path d="M9.992 10.023c0 .2-.062.399-.172.547l-4.996 7.492a.982.982 0 01-.828.454H1c-.55 0-1-.453-1-1 0-.2.059-.403.168-.551l4.629-6.942L.168 3.078A.939.939 0 010 2.528c0-.548.45-.997 1-.997h2.996c.352 0 .649.18.828.45L9.82 9.472c.11.148.172.347.172.55zm0 0"></path><path d="M19.98 10.023c0 .2-.058.399-.168.547l-4.996 7.492a.987.987 0 01-.828.454h-3c-.547 0-.996-.453-.996-1 0-.2.059-.403.168-.551l4.625-6.942-4.625-6.945a.939.939 0 01-.168-.55 1 1 0 01.996-.997h3c.348 0 .649.18.828.45l4.996 7.492c.11.148.168.347.168.55zm0 0"></path></g></svg></button></div></aside><main class="docMainContainer_3ufF"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_3FnS"><div class="docItemContainer_33ec"><article><div class="tocCollapsible_1PrD theme-doc-toc-mobile tocMobile_3Hoh"><button type="button" class="clean-btn tocCollapsibleButton_2O1e">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Componentizing the FML</h1></header><p>Currently the <code>nimbus-fml</code> tooling is only able to work on one file at a time.</p><p>It accepts a <code>nimbus.fml.yaml</code> file, and outputs a Kotlin or Swift file for inclusion in the product, or an <code>.experimenter.yaml</code> file for ingestion into Experimenter.</p><p>The pattern we have seen is that the application specifies code that:</p><ul><li>grows each time a new feature is added. This makes it hard to navigate.</li><li>is only able to generate code app code, which is not usable in any of the app&#x27;s components.</li></ul><p>This second restriction is most problematic: the app&#x27;s components (e.g. Fenix is made up of Android Components, Application Services, GeckoView and Gecko) are unable to instrument their code for experimentation, even though they by themselves might make up the majority of the codebase of the app.</p><p>This proposal discusses three new blocks in the FML specification, which are to implement including and importing FML files which easily solve these problems.</p><p>It allows for experimentation in the re-usable and library codebases that makes up most of our applications.</p><p>It enables cross-platform re-use of data definitions and schemas which will in turn, make it easier to reason about experimental features by experiment owners.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="goals"></a>Goals<a class="hash-link" href="#goals" title="Direct link to heading">#</a></h2><ul><li>The <code>nimbus.fml.yaml</code> file should be composable such the monolithic file can be broken up in to smaller pieces, potentially to live closer to the code it&#x27;s configuring.</li><li>The <code>.experimenter.yaml</code> ingested by Experimenter should give a complete picture of all the features available in the application.</li><li>The components (and their <code>fml.yaml</code> files) can live in a different repository to the application.</li><li>The components&#x27; feature code generation happens at component compile time</li><li>Generated feature code should be visible and configurable from the application<ul><li>e.g. Fenix and Focus might use the same feature from Android Components, but require different configuration.</li></ul></li></ul><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="non-goals"></a>Non-goals<a class="hash-link" href="#non-goals" title="Direct link to heading">#</a></h2><ul><li>versioning and branches:<ul><li>experiments are launched at a population of users using different versions of the app.</li><li>each specific version of the app is potentially built with a specific version of their components</li><li>for this proposal, easily varying the versions of components is not explored.</li></ul></li><li>local development<ul><li>for some feature development, working in multiple repos <em>at the same time</em> is necessary.</li><li>for this proposal, easily varying the paths or URLs of components is not explored, although this will likely involve a config file.</li></ul></li><li>namespacing<ul><li>currently names of feature, object, and enum classes are unique; collisions are disallowed</li><li>for this proposal, no attempt is made to allow classes of the same name to be used.</li></ul></li><li>connectors to different languages<ul><li>some features may be written in a different language or context to the one that the application is written in: e.g. C++, Rust or JS, or in an iOS app-extension.</li><li>for this proposal, this is only lighty discussed.</li></ul></li></ul><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="concepts"></a>Concepts<a class="hash-link" href="#concepts" title="Direct link to heading">#</a></h2><p>This proposal changes the way the <code>nimbus-fml</code> file is invoked, and adds three new structures to the Feature Manifest Language spec.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="invoking-the-nimbus-fml-command"></a>Invoking the <code>nimbus-fml</code> command<a class="hash-link" href="#invoking-the-nimbus-fml-command" title="Direct link to heading">#</a></h3><p>The following <code>nimbus-fml</code> commands can be run in fml files in either applications or components.</p><div class="tabs-container"><ul role="tablist" aria-orientation="horizontal" class="tabs"><li role="tab" tabindex="0" aria-selected="true" class="tabs__item tabItem_1uMI tabs__item--active">Android</li><li role="tab" tabindex="-1" aria-selected="false" class="tabs__item tabItem_1uMI">iOS</li></ul><div class="margin-vert--md"><div role="tabpanel"><p>Each component or app has its own <code>build.gradle</code>.</p><p>The following command is assembled and run by the Nimbus Gradle Plugin.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly sh"><pre tabindex="0" class="prism-code language-sh codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token plain">% nimbus-fml features --input component.fml.yaml --build-dir components/build/generated/debug/nimbus</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>This will generated exactly one Kotlin file.</p></div><div role="tabpanel" hidden=""><p>The following command is assembled and run by a Build Phase.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly sh"><pre tabindex="0" class="prism-code language-sh codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token plain">% nimbus-fml features --input component.fml.yaml --output component/Generated/component.swift</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>This will generated exactly one Swift file.</p><blockquote><p>Note: it would be trivial to specify the output directory (e.g. a <code>--build-dir</code> argument), but <code>xcodebuild</code> integration is easier if the BuildPhase can specify the filename.</p></blockquote></div></div></div><p>The following command is assembled and run at application build time only.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly sh"><pre tabindex="0" class="prism-code language-sh codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token plain">% nimbus-fml experimenter --input application.fml.yaml --output .experimenter.yaml</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>The <code>.experimenter.yaml</code> file is checked into source control, and ingested by Experimenter.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="paths-and-urls"></a>Paths and URLs<a class="hash-link" href="#paths-and-urls" title="Direct link to heading">#</a></h3><p>In several places paths to link one <code>.fml.yaml</code> file to another.</p><p>For convenience, we should use the conventions around URLs used in Carthage and npm package managers:</p><ul><li>a relative path must use <code>/</code> as a separator</li><li>a relative path may use <code>./</code> and <code>../</code> in their prefixes</li><li>an absolute URL may be used, but this must start with <code>https://</code></li><li>a Github repository may be specified with a prefix of <code>@</code>.<ul><li>e.g. <code>@mozilla/nimbus-shared</code> expands to <code>https://raw.githubusercontent.com/mozilla/nimbus-shared/main/</code></li></ul></li></ul><blockquote><p>Hint: The rules of the URL construction would be a good place to consider local development and branches.</p></blockquote><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="the-about-block"></a>The <code>about</code> block<a class="hash-link" href="#the-about-block" title="Direct link to heading">#</a></h3><p>The <code>about</code> block is an optional block in any given <code>.fml.yaml</code> file.</p><p>If present:</p><ul><li>the file may be used to generate a Swift or Kotlin file.</li><li>the file may be imported by another <code>.fml.yaml</code> file.</li></ul><p>If not present:</p><ul><li>the file may be included in another <code>.fml.yaml</code> file.</li></ul><p><code>about</code> associates a particular <code>.fml.yaml</code> file what Kotlin/Swift class and package/module this file will generate:</p><div class="tabs-container"><ul role="tablist" aria-orientation="horizontal" class="tabs"><li role="tab" tabindex="0" aria-selected="true" class="tabs__item tabItem_1uMI tabs__item--active">Kotlin</li><li role="tab" tabindex="-1" aria-selected="false" class="tabs__item tabItem_1uMI">Swift</li></ul><div class="margin-vert--md"><div role="tabpanel"><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token key atrule">about</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">class</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain">   .nimbus.MyNimbus</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">package</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> mozilla.components.search</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>The <code>package</code> property <strong>must</strong> correspond to the app&#x27;s namespace, where the <code>R</code> and <code>BuildConfig</code> files are generated.</p><p>The <code>class</code> property is the qualified name of the class that will be generated. If the <code>class</code> has <code>.</code> as a prefix, the fully qualified name is created by appending the <code>package</code> to the <code>class</code>. The filename is taken to be the final segment of the fully qualified name.</p><p>For Android developers, this should be the familiar way <code>android:name</code> is specified in the <code>AndroidManifest.xml</code>.</p></div><div role="tabpanel" hidden=""><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token key atrule">about</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">class</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain">   AccountsNimbus</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">module</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain">  Accounts</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>The <code>module</code> property is the name of the module the generate class will be in.</p><p>The <code>class</code> is the name of the class used to access the features.</p></div></div></div><p>As with existing <code>.fml.yaml</code> files, any file with an <code>about</code> block, <strong>must</strong> contain a <code>channels</code> list. e.g.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token key atrule">channels</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> release</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> beta</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> developer</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> testing</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="the-include-list"></a>The <code>include</code> list<a class="hash-link" href="#the-include-list" title="Direct link to heading">#</a></h3><p>This is a list of files which will be merged with this one. The files may be relative to this one, absolute or URLs.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token key atrule">include</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> nimbus/search.yaml</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> @mozilla/nimbus</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">shared/fml/messaging.yaml</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Each element in the list is a path or URL to another file to be included into this one.</p><p>Included files:</p><ul><li>must not contain an <code>about</code> block,</li><li>must not contain a <code>channels</code> list, or must match the <code>channels</code> list of the including file.</li></ul><p>Including a file means that contents of the <code>features</code>, <code>objects</code> and <code>enums</code> blocks will be appended from the included file to the including file. Any collisions will cause an error, i.e. if two files declare a type of the same name, this should cause an error.</p><p>Included files may include other files. These files may be remote or on a local filesystem.</p><p>Including the same file twice should be a no-op.</p><p>Included files may import files. These files may be remote or on a local filesystem.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="the-import-list"></a>The <code>import</code> list<a class="hash-link" href="#the-import-list" title="Direct link to heading">#</a></h3><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token key atrule">import</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">path</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain">    ../Accounts/nimbus.fml.yaml</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token key atrule">channel</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> production</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">path</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain">    @mozilla</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">mobile/ios</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">components/components/feature/search/nimbus.fml.yaml</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token key atrule">channel</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> release</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>The list contains blocks with the following mandatory properties:</p><ul><li><code>path</code>: this string value is a relative path or URL to the imported file.</li><li><code>channel</code>: this string value is the name of a channel. The channel <strong>must</strong> be in the channel list of the included file.</li></ul><p>An imported file:</p><ul><li><strong>must</strong> have an <code>about</code> block.</li><li><strong>may</strong> have an <code>include</code> block.</li></ul><p>Optionally, a <code>features</code> block is provided, which is a <code>Map&lt;FeatureId, List&lt;DefaultBlock&gt;&gt;</code>. This provides a way of configuring components.</p><p>A list of <code>DefaultBlock</code>s is the same way feature defaulting, and channel specific defaulting works when specifying a feature.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token key atrule">import</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">path</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain">    ../Accounts/nimbus.fml.yaml</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token key atrule">channel</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> production</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token key atrule">features</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token key atrule">accounts</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">value</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                </span><span class="token key atrule">button-color</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> blue</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>The <code>value</code> used by the imported code will come from the importing code.</p><h4><a aria-hidden="true" tabindex="-1" class="anchor anchor__h4 anchorWithStickyNavbar_31ik" id="unclearscopecreepyagni"></a>Unclear/scopeâ€“creep/YAGNI<a class="hash-link" href="#unclearscopecreepyagni" title="Direct link to heading">#</a></h4><ul><li>The importing <code>.fml.yaml</code> file should not have access to types from the imported one.</li><li>The imported file may not have an <code>import</code> list.</li></ul><blockquote><p>Eventually it might be necessary to have imported files recursively importing other files.
Implementing this proposal will give an idea of how much extra complexity is required.</p></blockquote><h4><a aria-hidden="true" tabindex="-1" class="anchor anchor__h4 anchorWithStickyNavbar_31ik" id="connecting-to-different-languages-or-contexts"></a>Connecting to different languages or contexts<a class="hash-link" href="#connecting-to-different-languages-or-contexts" title="Direct link to heading">#</a></h4><p>The <code>import</code> block does two different roles:</p><ol><li>Giving <code>experimenter</code> knowledge of the imported features.</li><li>Sending experimental configuration from the application singleton into the components.</li></ol><p>For features written in a different language, the feature configuration needs to travel across an FFI.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token key atrule">import</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">path</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain">      @mozilla/gecko</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">dev/fenix.fml.yaml</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">channel</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain">   production</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">connector</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> gecko</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">view</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">features</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token key atrule">autofill</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">value</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Imports for the same connector are gathered up so we can get a <code>Map&lt;String, JSONObject&gt;</code> containing configuration from the experiment (and the app-specific defaults) by calling:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly kotlin"><pre tabindex="0" class="prism-code language-kotlin codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token plain">FxNimbus.connectors.geckoView.value()</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>The app will need to send this to the right place, for example:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly kotlin"><pre tabindex="0" class="prism-code language-kotlin codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token plain">val nimbus = Nimbus.shared</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">nimbus.register(object : Nimbus.Observer {</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    fun onExperimentsApplied() {</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        val features: Map&lt;String, JSONObject&gt; = FxNimbus.connectors.geckoView.value()</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        geckoView.setNimbusFeatures(features)</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">})</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="implementation-notes"></a>Implementation notes<a class="hash-link" href="#implementation-notes" title="Direct link to heading">#</a></h2><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="illustrative-sketch"></a>Illustrative sketch<a class="hash-link" href="#illustrative-sketch" title="Direct link to heading">#</a></h3><p>Consider two projects that are already linked: the app, and the components. One of the components is a messaging feature which we&#x27;d like to be able to use in the app.</p><p>The app needs to initialize the messaging component with specific configuration, not available to the component when it was compiled.</p><h4><a aria-hidden="true" tabindex="-1" class="anchor anchor__h4 anchorWithStickyNavbar_31ik" id="two-fml-files"></a>Two FML files<a class="hash-link" href="#two-fml-files" title="Direct link to heading">#</a></h4><p>In <code>../components/messaging.fml.yaml</code></p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token key atrule">about</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">class</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain">   .nimbus.ComponentNimbus</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">package</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> org.example.components</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token key atrule">channels</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> testing</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> staging</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> production</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token key atrule">features</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">messaging</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># definition elided, for clarity</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># We include one variable for illustration</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token key atrule">variable</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token key atrule">triggers</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                </span><span class="token key atrule">type</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> Map&lt;String</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> String</span><span class="token punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token key atrule">defaults</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">channel</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> production</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">              </span><span class="token key atrule">value</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                </span><span class="token key atrule">triggers</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                    </span><span class="token key atrule">ALWAYS</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;true&quot;</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                    </span><span class="token key atrule">NEVER</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain">  </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;false&quot;</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>The top level file, <code>app.fml.yaml</code>.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token key atrule">about</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">class</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain">   .nimbus.AppNimbus</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">package</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> org.example.app</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token key atrule">channels</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> developer</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> nightly</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> beta</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> release</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token key atrule">import</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">path</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain">    ../components/messaging.fml.yaml</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token key atrule">channel</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> production</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token key atrule">features</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token key atrule">messaging</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">channel</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> release</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">              </span><span class="token key atrule">value</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                </span><span class="token key atrule">I_AM_DEFAULT_BROWSER</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain">     is_default_browser == true</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                </span><span class="token key atrule">I_AM_NOT_DEFAULT_BROWSER</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> is_default_browser </span><span class="token tag" style="color:rgb(255, 85, 114)">!=</span><span class="token plain"> true</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor anchor__h4 anchorWithStickyNavbar_31ik" id="the-corresponding-kotlin-files"></a>The corresponding Kotlin files<a class="hash-link" href="#the-corresponding-kotlin-files" title="Direct link to heading">#</a></h4><p>Running <code>nimbus-fml</code> on <code>messaging.fml.yaml</code> in the components directory, with the <code>channel</code> as <code>production</code> generates:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly kotlin"><pre tabindex="0" class="prism-code language-kotlin codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token plain">package org.example.components.nimbus</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">import org.example.components.R</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">class ComponentNimbus {</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    var api: NimbusFeaturesInterface?</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    â€¦</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">class Messaging</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    private constructor(â€¦) {</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    constructor(</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        _variables: Variables = NullVariables.instance,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        triggers: Map&lt;String, String&gt; = mapOf(</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            &quot;ALWAYS&quot; to &quot;true&quot;,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            &quot;NEVER&quot; to &quot;false&quot;</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        )</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    )</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>When running the <code>nimbus-fml</code> command with the <code>release</code> channel, the component file is imported.</p><p>The generated file looks like:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly kotlin"><pre tabindex="0" class="prism-code language-kotlin codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token plain">package org.example.app.nimbus</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">import org.example.component.ComponentNimbus</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">import org.example.app.R</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">class AppNimbus {</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    var api: NimbusFeaturesInterface? = null</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        set(value) {</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            ComponentNimbus.api = value</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    companion object {</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        init() {</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            ComponentNimbus.features.messaging.withConfiguration { _variables -&gt;</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                Messaging(</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                    _variables,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                    triggers = mapOf(</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                        &quot;ALWAYS&quot; to &quot;true&quot;,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                        &quot;NEVER&quot; to &quot;false&quot;,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                        &quot;I_AM_DEFAULT_BROWSER&quot; to &quot;is_default_browser == true&quot;,</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                        &quot;I_AM_NOT_DEFAULT_BROWSER&quot; to &quot;is_default_browser != true&quot;</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                    )</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                )</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            }</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Several places to highlight in this code:</p><ul><li>The class names and package names are gained from the <code>about</code> blocks of the imported files.</li><li>The <code>api</code> property connects the Nimbus SDK to the generated code. Setting this lets the <code>AppNimbus</code> get configuration from the server. The setter now sets the <code>api</code> all imported (and generated above) classesâ€”Â in this case <code>ComponentNimbus</code>.</li><li>The companion object <code>init</code> block calls <code>withConfiguration</code> as soon as <code>AppNimbus</code> is used. <code>withConfiguration</code> is a new method on <code>FeatureHolder</code> which provides an alternative <code>create</code> closure. It has to be public and is named as to appear after <code>value()</code> in the list auto-completed identifiers offered by IDEs. The new configuration comes from merging the component default with the app default.</li></ul><p>So when <code>ComponentNimbus.features.messaging.value()</code> is called, even from within the component itself, it returns configuration from the Nimbus SDK, and defaults from the app.</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/mozilla/experimenter-docs/edit/main/docs/deep-dives/specifications/fml-imports.mdx" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_2_ui" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_13-_"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/fml-front-end-format"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Â« Feature Manifest Language Front-end Format As YAML</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/fml-spec"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">The Feature Manifest Language spec Â»</div></a></div></nav></div></div><div class="col col--3"><div class="tableOfContents_35-E thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#goals" class="table-of-contents__link">Goals</a></li><li><a href="#non-goals" class="table-of-contents__link">Non-goals</a></li><li><a href="#concepts" class="table-of-contents__link">Concepts</a><ul><li><a href="#invoking-the-nimbus-fml-command" class="table-of-contents__link">Invoking the <code>nimbus-fml</code> command</a></li><li><a href="#paths-and-urls" class="table-of-contents__link">Paths and URLs</a></li><li><a href="#the-about-block" class="table-of-contents__link">The <code>about</code> block</a></li><li><a href="#the-include-list" class="table-of-contents__link">The <code>include</code> list</a></li><li><a href="#the-import-list" class="table-of-contents__link">The <code>import</code> list</a></li></ul></li><li><a href="#implementation-notes" class="table-of-contents__link">Implementation notes</a><ul><li><a href="#illustrative-sketch" class="table-of-contents__link">Illustrative sketch</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer"><div class="container"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright Â© 2022 Mozilla Corporation</div></div></div></footer></div>
<script src="/assets/js/runtime~main.209e946f.js"></script>
<script src="/assets/js/main.1ade32ac.js"></script>
</body>
</html>